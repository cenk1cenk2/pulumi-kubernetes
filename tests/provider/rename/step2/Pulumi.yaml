name: rename
runtime: yaml
description: |
  Tests edge cases around resource deletion and renames.

  - Changing a resource's name, but leaving .metadata untouched, should not
    result in a deletion from the cluster.

  - Deleting a logical patch resource should not delete the underlying physical
    resource.

outputs:
  managedFields: ${patch1.metadata.managedFields}

resources:
  # Change the name in Pulumi (ns->namespace) but leave everything else the
  # same.
  namespace:
    type: kubernetes:core/v1:Namespace
    properties:
      metadata:
        name: rename-namespace
        namespace: rename-namespace

  pod:
    type: kubernetes:core/v1:Pod
    properties:
      metadata:
        namespace: rename-namespace
      spec:
        containers:
          - image: nginx:1.14.2
            name: nginx
            ports:
              - containerPort: 80

  configmap:
    type: kubernetes:core/v1:ConfigMap
    properties:
      metadata:
        name: patched-configmap

  patch1:
    type: kubernetes:core/v1:ConfigMapPatch
    properties:
      metadata:
        name: patched-configmap
      data:
        foo: bar
    options:
      dependsOn:
        - ${configmap}

  # Delete patch2 - the underlying ConfigMap should not be deleted, and patch1
  # should still be applied.
  #
  # patch2:
  #   type: kubernetes:core/v1:ConfigMapPatch
  #   properties:
  #     metadata:
  #       name: patched-configmap
  #     data:
  #       boo: baz
  #   options:
  #     dependsOn:
  #       - ${patch1}
